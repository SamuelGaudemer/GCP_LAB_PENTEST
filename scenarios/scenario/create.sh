#!/bin/bash


# Setting up project
pid=$(gcloud config list --format 'value(core.project)' )  
gcloud config set project $pid 

name=$1

if [[ -n "$name" ]]; then 
pid=$(gcloud config list --format 'value(core.project)' )  


gcloud config set project $pid 


# creating bucket


echo "Creating Bucket"

gsutil mb gs://$pid/ 
gsutil mb gs://$pid-credit-card/ 

echo "Creating Service Account"

# Creating task 

gcloud iam service-accounts create $name --display-name="$name"  


email=$name@$pid.iam.gserviceaccount.com  

# creating key 
gcloud iam service-accounts keys create ./service-key.json --iam-account $email  

# adding the roles
gcloud projects add-iam-policy-binding $pid --role roles/storage.admin --role roles/iam.serviceAccountUser --role roles/compute.instanceAdmin.v1 --role roles/compute.instanceAdmin.v1 --member serviceAccount:$email 


echo "Copying the contents to the Bucket"

# copying the file to the bucket
gsutil cp service-key.json gs://$pid/ 

# making the bucket publicly accessible

gsutil iam ch allUsers:objectViewer gs://$pid/ 

echo Now go to the below url https://storage.googleapis.com/$pid/

rm service-key.json

else
    echo "Enter the Service account-name"
fi

# creating instance

echo "Creating Compute instances"
gcloud compute instances create test --machine-type=f1-micro --zone=asia-east1-a --image-family ubuntu-1804-lts --image-project ubuntu-os-cloud --metadata-from-file startup-script=docker-install.sh 
gcloud compute instances create secret --machine-type=f1-micro --zone=asia-east1-a --image-family ubuntu-1804-lts --image-project ubuntu-os-cloud --metadata-from-file startup-script=secret-install.sh 

# creating sqlinstance 

echo "creating the sql instance"

gcloud sql instances create $name --database-version=MYSQL_5_7 --tier=db-f1-micro  --zone=asia-east1-a  

ip=$(gcloud sql instances describe $name | grep "ipAddress" | sed -n 2P | awk -F ':' '{print $2}')

echo The ipAddress of the sql instance is $ip
else
    echo "Enter the Sql-instance Name"
fi

gcloud sql connect $name --user=root

CREATE TABLE flags (num INT, flag VARCHAR(100));
INSERT INTO flags (flag) VALUES (1,'SCAM{FIRST_FLAG_FOUND_NICE!}'); #SSRF (in source code)
INSERT INTO flags (flag) VALUES (2,'SCAM{SSTI!!}'); #SSTI (in VM)
INSERT INTO flags (flag) VALUES ('SCAM{DID_U_USE_CHAT_GCP?}'); # in PIVOT

exit


# creating firewall


echo "Creating firewall"
 gcloud compute firewall-rules create http2 --description="Incoming http allowed." \
     --allow tcp:80  

# getting ip

#fonctionne pas ? // TO DO afficher l'ip externe bien 
ip=$(gcloud compute instances  list | sed -n 6p)

echo The application can accessed at $ip
